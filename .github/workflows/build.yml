name: test

on:
  push:
    branches:
      - main

env:
  PUBLISH_DIRECTORY: public

permissions:
  contents: write

jobs:
  tests:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    - name: Checkout Production
      if: github.ref_name == 'main'
      uses: actions/checkout@v4
      with:
        ref: asf-site
        path: ${{ env.PUBLISH_DIRECTORY }}
    - name: Install Hugo
      run: |
        sudo apt-get update
        sudo apt-get install -y asciidoctor
        wget https://github.com/gohugoio/hugo/releases/download/v0.128.0/hugo_extended_0.128.0_linux-amd64.deb
        sudo dpkg -i hugo_extended_0.128.0_linux-amd64.deb
    - name: Prepare
      working-directory: ${{ env.PUBLISH_DIRECTORY }}
      run: |
        rm -rf stylesheets
        which hugo
        hugo version
    - name: Build Hugo site
      run: |
        hugo mod clean --all
        git submodule update --init --recursive
        npm install
        hugo
  
    #- name: Deploy to ASF
    #  run: |
    #    cp -r public/* $GITHUB_WORKSPACE/public/